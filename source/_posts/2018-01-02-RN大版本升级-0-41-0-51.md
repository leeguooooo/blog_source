title: RN大版本升级 0.41 -> 0.51
date: 2018-01-02 19:53:45
author: 郭立lee
category: react native
tags: [RN]
photos: https://ws1.sinaimg.cn/large/005T0OjCly1fn2igovf0vj30kk0dz0yv.jpg
---

## 前言
> 没什么可说的, 直接搞起..

  [增量升级方案](https://segmentfault.com/a/1190000004352162)

  [react native 中文网](https://reactnative.cn/docs/0.51/upgrading.html#content)

## Lv. UP!

### 安装react-native-git-upgrade工具模块

```shell
npm install -g react-native-git-upgrade
```
### 运行更新命令

```shell
react-native-git-upgrade
# 把react native升级到最新版本

# 或者是：

react-native-git-upgrade X.Y.Z
# 把react native升级到指定的X.Y.Z版本
```

### 解决冲突

文件中的冲突会以分隔线隔开，并清楚的标记出处，例如下面这样：

```js
13B07F951A680F5B00A75B9A /* Release */ = {
  isa = XCBuildConfiguration;
  buildSettings = {
    ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon;
<<<<<<< ours
    CODE_SIGN_IDENTITY = "iPhone Developer";
    FRAMEWORK_SEARCH_PATHS = (
      "$(inherited)",
      "$(PROJECT_DIR)/HockeySDK.embeddedframework",
      "$(PROJECT_DIR)/HockeySDK-iOS/HockeySDK.embeddedframework",
    );
=======
    CURRENT_PROJECT_VERSION = 1;
>>>>>>> theirs
    HEADER_SEARCH_PATHS = (
      "$(inherited)",
      /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/include,
      "$(SRCROOT)/../node_modules/react-native/React/**",
      "$(SRCROOT)/../node_modules/react-native-code-push/ios/CodePush/**",
    );
```

* 上面代码中的"ours"表示你自己的代码，而"theirs"表示React Native的官方代码。然后你可以根据实际情况判断，选择某一方晋级，另一方出局

### 新增index.js

```js
将 index.android.js 重命名为 index.js
然后把 index.ios.js 删除。
```

### 更新react-native的node依赖包

    npm install

译注：从0.24版本开始，react-native还需要额外安装react模块，且对react的版本有严格要求，高于或低于某个范围都不可以。本文无法在这里列出所有react native和对应的react模块版本要求，只能提醒读者先尝试执行npm install，然后注意观察安装过程中的报错信息，例如require react@某.某.某版本, but none was installed，然后根据这样的提示，执行npm install react@某.某.某版本 --save

###  升级项目模板文件

    react-native upgrade

这一命令会检查最新的项目模板，然后进行如下操作：

* 如果是新添加的文件，则直接创建。
* 如果文件和当前版本的文件相同，则跳过。
* 如果文件和当前版本的文件不同，则会提示你一些选项：查看两者的不同，选择保留你的版本或是用新的模板覆盖。你可以按下h键来查看所有可以使用的命令。

译注：如果你有修改原生代码，那么在使用upgrade升级前，先备份，再覆盖。覆盖完成后，使用比对工具找出差异，将你之前修改的代码逐步搬运到新文件中。

### 手动升级

如果项目较大还有很多东西需要手动修改



----
****

## 项目升级实例

### react native部分(opsapp-rn项目)

* 修改`package.json`中`react`,`react-native`版本
* `qnpm install`
* 根据react native 的changelog 修改不兼容的代码，同时需要注意用到的某些开源组件，是否对新版本兼容。
修改不兼容的组件，升级/修改源码/重换组件

### ios部分

* 更新依赖, 修改react,react-native版本.
* `rm -rf node_modules`
* `qnpm install`
* `pod install --no-repo-update`
* 清理xcode/模拟器缓存
* 如果确认自己代码没问题，相关依赖也都正确，试试清空 watchman/模拟器/xcode 缓存，清理的时候，关闭npm start，模拟器，xcode

> 如果 pod install 报错 `-bash: /usr/local/bin/pod: /System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/bin/ruby: bad interpreter: No such file or directory`, [解决方案](https://madordie.github.io/post/macos-high-sierra-cocoapods/)
